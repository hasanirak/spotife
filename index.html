<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#240046">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="أنغامي العراق">
    
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,{"name":"%D8%A3%D9%86%D8%BA%D8%A7%D9%85%D9%8A%20%D8%A7%D9%84%D8%B9%D8%B1%D8%A7%D9%82","short_name":"Anghami","start_url":".","display":"standalone","background_color":"#121212","theme_color":"#a136e0","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/725/725350.png","sizes":"512x512","type":"image/png"}]}'>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/725/725350.png">

    <title>أنغامي العراق | أغاني كاملة</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #ff00d2;
            --secondary: #a136e0;
            --gradient-start: #240046;
            --gradient-end: #0a0a0a;
            --bg-card: rgba(255, 255, 255, 0.05);
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
            --player-height: 90px;
            --nav-height: 65px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--gradient-end);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .app-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            z-index: -2;
        }

        /* --- Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - var(--player-height));
            overflow: hidden;
        }

        /* Sidebar (Desktop) */
        .sidebar {
            width: 260px;
            background-color: rgba(0,0,0,0.3);
            backdrop-filter: blur(15px);
            padding: 24px 15px;
            display: flex;
            flex-direction: column;
            gap: 30px;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.6rem;
            font-weight: 800;
        }
        .logo i { 
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.2rem;
        }

        .nav-links { list-style: none; display: flex; flex-direction: column; gap: 5px; }
        .nav-link {
            display: flex; align-items: center; gap: 15px;
            padding: 12px 15px; color: var(--text-sub);
            text-decoration: none; font-weight: 600; border-radius: 12px;
            transition: 0.3s; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { color: white; background: var(--bg-card); }
        .nav-link.active i { color: var(--primary); }

        /* Main Content */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 120px;
            scroll-behavior: smooth;
        }

        /* Header */
        .top-bar {
            height: 70px;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(10,10,10,0.5);
            backdrop-filter: blur(20px);
        }

        .search-container {
            background: rgba(255,255,255,0.08);
            border-radius: 50px;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            width: 350px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .search-container input {
            background: transparent; border: none; color: white; flex: 1; padding: 5px 10px;
            font-family: inherit; font-size: 0.95rem;
        }

        .mobile-header {
            display: none;
            padding: 25px 20px 10px;
            font-size: 1.8rem;
            font-weight: 900;
        }

        /* Sections */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 25px 15px;
        }
        .section-header h2 { font-size: 1.3rem; font-weight: 800; }
        .section-header span { font-size: 0.85rem; color: var(--primary); font-weight: 700; cursor: pointer; }

        .horizontal-list {
            display: flex; gap: 20px; overflow-x: auto; padding: 0 25px 20px;
            scrollbar-width: none;
        }
        .horizontal-list::-webkit-scrollbar { display: none; }

        /* Music Card */
        .music-card {
            min-width: 155px; width: 155px;
            cursor: pointer; transition: 0.3s;
        }
        .music-card:active { transform: scale(0.95); }
        .img-box {
            position: relative; width: 100%; padding-top: 100%;
            border-radius: 15px; overflow: hidden; margin-bottom: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            background: #222;
        }
        .img-box img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: 0.5s; opacity: 0; }
        .img-box img.loaded { opacity: 1; }
        .music-card:hover img { transform: scale(1.1); }
        
        .card-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-subtitle { font-size: 0.75rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Full Song Player --- */
        .player-bar {
            height: var(--player-height);
            background: rgba(15, 15, 15, 0.92);
            backdrop-filter: blur(30px);
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 25px; position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 500;
        }

        .track-info { display: flex; align-items: center; gap: 15px; width: 30%; }
        .track-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.5); background: #222; }
        .track-name { font-weight: 800; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-artist { font-size: 0.8rem; color: var(--text-sub); }

        .player-center { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 40%; }
        .main-controls { display: flex; align-items: center; gap: 30px; }
        .p-btn { background: none; border: none; color: white; font-size: 1.3rem; cursor: pointer; transition: 0.2s; }
        .p-btn:hover { color: var(--primary); }
        .play-pause-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; box-shadow: 0 5px 20px rgba(255,0,210,0.4);
        }

        .progress-bar-wrapper { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 0.7rem; color: var(--text-sub); }
        .progress-bar-container { flex: 1; height: 5px; background: rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; position: relative; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(to left, var(--primary), var(--secondary)); border-radius: 10px; position: relative; }

        .player-right { display: flex; align-items: center; gap: 20px; width: 30%; justify-content: flex-end; }
        .dl-btn { font-size: 1.4rem; color: white; cursor: pointer; }

        #yt-player-hidden { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        /* Mobile Bottom Nav */
        .mobile-nav {
            display: none;
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height); background: rgba(10,10,10,0.98);
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .m-nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-sub); font-size: 1.4rem; gap: 4px; flex: 1;
        }
        .m-nav-item span { font-size: 0.7rem; font-weight: 600; }
        .m-nav-item.active { color: var(--primary); }

        /* Views */
        .view-content { display: none; }
        .view-content.active { display: block; }

        @media (max-width: 768px) {
            .sidebar, .top-bar { display: none !important; }
            .mobile-header { display: block; }
            .main-container { height: calc(100vh - var(--player-height) - var(--nav-height)); }
            .player-bar { 
                bottom: calc(var(--nav-height) + 10px); 
                left: 10px; right: 10px; 
                border-radius: 15px; 
                height: 70px; 
                margin-bottom: 5px;
                border: none;
                background: rgba(30, 30, 30, 0.95);
            }
            .track-info { width: 75%; }
            .player-center { width: auto; }
            .player-right, .progress-bar-wrapper { display: none !important; }
            .mobile-nav { display: flex; }
            .music-card { min-width: 145px; width: 145px; }
        }
    </style>
</head>
<body>

    <div class="app-bg"></div>
    <div id="yt-player-hidden"></div>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-play-circle"></i>
                <span>أنغامي</span>
            </div>
            <ul class="nav-links">
                <li class="nav-link active" onclick="showView('discover')"><i class="fas fa-compass"></i> اكتشف</li>
                <li class="nav-link" onclick="showView('search')"><i class="fas fa-search"></i> بحث</li>
                <li class="nav-link" onclick="showView('library')"><i class="fas fa-heart"></i> المكتبة</li>
                <li class="nav-link" style="margin-top:auto; color:var(--primary);"><i class="fas fa-user-circle"></i> حسن داود</li>
            </ul>
        </aside>

        <main class="content-area" id="main-content-scroll">
            <!-- Header -->
            <header class="top-bar">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="pc-search-in" placeholder="ابحث عن أغنية كاملة...">
                </div>
                <div style="font-weight:700;">عراق ميوزك | المطور حسن داود</div>
            </header>

            <div class="mobile-header" id="mob-title">اكتشف</div>

            <!-- Discover View -->
            <div id="view-discover" class="view-content active">
                <div class="section-header">
                    <h2>الأكثر استماعاً في العراق</h2>
                    <span onclick="runFullSearch('عراقي حصري 2024')">مشاهدة الكل</span>
                </div>
                <div class="horizontal-list" id="list-iraq">
                    <div style="padding: 20px; color: #777;"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>
                </div>

                <div class="section-header">
                    <h2>إصدارات جديدة كاملة</h2>
                    <span onclick="runFullSearch('Arabic New 2024')">مشاهدة الكل</span>
                </div>
                <div class="horizontal-list" id="list-new">
                    <div style="padding: 20px; color: #777;"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>
                </div>

                <div class="section-header">
                    <h2>راديو المشاهير</h2>
                    <span>استمع</span>
                </div>
                <div class="horizontal-list" id="list-radio">
                    <div style="padding: 20px; color: #777;"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>
                </div>
            </div>

            <!-- Search View -->
            <div id="view-search" class="view-content" style="padding: 20px 25px;">
                <div class="search-container" style="width: 100% !important; margin-bottom: 25px;">
                    <input type="text" id="mob-search-in" placeholder="اسم الأغنية أو الفنان...">
                    <i class="fas fa-microphone" style="margin-right: 15px;"></i>
                </div>

                <div id="results-area" style="display:none;">
                    <div class="section-header" style="padding-left:0;"><h2>نتائج البحث</h2></div>
                    <div class="horizontal-list" id="search-grid" style="flex-wrap: wrap; height: auto; gap:15px; padding:0;"></div>
                </div>

                <div id="categories-area">
                    <div style="font-weight:800; font-size:1.2rem; margin-bottom:15px;">تصفح حسب النوع</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; padding-bottom:100px;">
                        <div onclick="runFullSearch('Pop Arabic')" style="background:#8D67AB; height:90px; border-radius:12px; padding:15px; font-weight:800; position:relative; overflow:hidden;">بوب عربي<img src="https://t.scdn.co/images/0a74d96e091a495bb09c0d83210910c3" style="position:absolute; right:-10px; bottom:0; width:60px; transform:rotate(20deg);"></div>
                        <div onclick="runFullSearch('عراقي حزين')" style="background:#E91E63; height:90px; border-radius:12px; padding:15px; font-weight:800; position:relative; overflow:hidden;">عراقي حزين<img src="https://i.scdn.co/image/ab67706f000000025f828753235d94924c581a06" style="position:absolute; right:-10px; bottom:0; width:60px; transform:rotate(20deg);"></div>
                        <div onclick="runFullSearch('دبكات')" style="background:#1E3264; height:90px; border-radius:12px; padding:15px; font-weight:800; position:relative; overflow:hidden;">دبكات<img src="https://i.scdn.co/image/ab67706f00000002b88126c06a86e885d95e0926" style="position:absolute; right:-10px; bottom:0; width:60px; transform:rotate(20deg);"></div>
                        <div onclick="runFullSearch('Khaliji')" style="background:#148A08; height:90px; border-radius:12px; padding:15px; font-weight:800; position:relative; overflow:hidden;">خليجي<img src="https://i.scdn.co/image/ab67706f0000000213d2f9d8540c11438914b150" style="position:absolute; right:-10px; bottom:0; width:60px; transform:rotate(20deg);"></div>
                    </div>
                </div>
            </div>

            <!-- Library View -->
            <div id="view-library" class="view-content" style="padding: 20px 25px;">
                <div class="section-header" style="padding-left:0;"><h2>مكتبتي الموسيقية</h2></div>
                <div class="horizontal-list" id="lib-grid" style="flex-wrap: wrap; height: auto; gap:15px; padding:0;">
                    <!-- Saved songs -->
                </div>
            </div>
        </main>
    </div>

    <!-- Professional Player -->
    <footer class="player-bar">
        <div class="track-info">
            <img src="https://via.placeholder.com/150" class="track-img" id="p-img">
            <div class="track-details">
                <div class="track-name" id="p-name">جاهز للتشغيل</div>
                <div class="track-artist" id="p-artist">اختر أغنية كاملة</div>
            </div>
        </div>

        <div class="player-center">
            <div class="main-controls">
                <button class="p-btn"><i class="fas fa-random"></i></button>
                <button class="p-btn"><i class="fas fa-step-backward"></i></button>
                <button class="p-btn play-pause-btn" id="master-play" onclick="handlePlayPause()">
                    <i class="fas fa-play"></i>
                </button>
                <button class="p-btn"><i class="fas fa-step-forward"></i></button>
                <button class="p-btn" onclick="toggleLike()"><i class="far fa-heart" id="p-like"></i></button>
            </div>
            <div class="progress-bar-wrapper">
                <span id="time-cur">0:00</span>
                <div class="progress-bar-container" id="prog-container">
                    <div class="progress-fill" id="prog-fill"></div>
                </div>
                <span id="time-total">3:45</span>
            </div>
        </div>

        <div class="player-right">
            <i class="fas fa-arrow-circle-down dl-btn" id="dl-icon" onclick="downloadCurrent()"></i>
            <i class="fas fa-volume-up p-btn"></i>
        </div>
    </footer>

    <!-- Mobile Nav -->
    <nav class="mobile-nav">
        <div class="m-nav-item active" id="m-discover" onclick="showView('discover')"><i class="fas fa-compass"></i><span>اكتشف</span></div>
        <div class="m-nav-item" id="m-search" onclick="showView('search')"><i class="fas fa-search"></i><span>بحث</span></div>
        <div class="m-nav-item" id="m-library" onclick="showView('library')"><i class="fas fa-music"></i><span>المكتبة</span></div>
    </nav>

    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- Core Variables ---
        let ytPlayer;
        let currentTrack = null;
        let library = JSON.parse(localStorage.getItem('anghami_v2_lib') || '[]');
        let isPlaying = false;

        // --- Improved View Controller ---
        function showView(view) {
            document.querySelectorAll('.view-content').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.nav-link, .m-nav-item').forEach(l => l.classList.remove('active'));
            
            const viewEl = document.getElementById('view-' + view);
            if(viewEl) viewEl.style.display = 'block';
            
            if(window.innerWidth > 768) {
                const lnks = document.querySelectorAll('.nav-link');
                if(view === 'discover') lnks[0].classList.add('active');
                if(view === 'search') lnks[1].classList.add('active');
                if(view === 'library') lnks[2].classList.add('active');
            } else {
                const mobNav = document.getElementById('m-' + view);
                if(mobNav) mobNav.classList.add('active');
                const titles = { discover: 'اكتشف', search: 'بحث', library: 'المكتبة' };
                document.getElementById('mob-title').innerText = titles[view] || 'أنغامي';
            }
            if(view === 'library') buildLibrary();
            document.getElementById('main-content-scroll').scrollTop = 0;
        }

        // --- YouTube Engine ---
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('yt-player-hidden', {
                height: '1', width: '1',
                events: {
                    'onStateChange': onPlayerStateChange,
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady() {
            setInterval(updateProgress, 1000);
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                isPlaying = true;
                updateMasterBtn(true);
                const duration = ytPlayer.getDuration();
                document.getElementById('time-total').innerText = formatTime(duration);
            } else {
                isPlaying = false;
                updateMasterBtn(false);
            }
        }

        // --- Robust Playback Logic ---
        async function playFullTrack(track) {
            currentTrack = track;
            document.getElementById('p-name').innerText = track.title;
            document.getElementById('p-artist').innerText = track.artist;
            document.getElementById('p-img').src = track.img;
            updateLikeIcon();

            const query = `${track.title} ${track.artist} official audio full song`;
            const ytId = await findYouTubeId(query);
            
            if(ytId && ytPlayer && ytPlayer.loadVideoById) {
                ytPlayer.loadVideoById(ytId);
                ytPlayer.playVideo();
            } else {
                console.log("YouTube ID fallback trigger...");
                // Just in case, try searching without "full song"
                const ytIdBackup = await findYouTubeId(`${track.title} ${track.artist}`);
                if(ytIdBackup) {
                    ytPlayer.loadVideoById(ytIdBackup);
                    ytPlayer.playVideo();
                }
            }

            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: track.title, artist: track.artist, artwork: [{ src: track.img, sizes: '512x512', type: 'image/jpeg' }]
                });
            }
        }

        async function findYouTubeId(query) {
            const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&limit=1&country=IQ`;
            // Note: We are using a search trick or proxy to get YT info. 
            // Since we can't have a backend, we use a public proxy to fetch YT search results safely.
            const searchUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent('https://www.youtube.com/results?search_query=' + query)}`;
            try {
                const res = await fetch(searchUrl);
                const html = await res.text();
                const match = html.match(/"videoId":"([^"]+)"/);
                return match ? match[1] : null;
            } catch (e) { return null; }
        }

        function handlePlayPause() {
            if(!ytPlayer) return;
            if(isPlaying) ytPlayer.pauseVideo(); else ytPlayer.playVideo();
        }

        function updateMasterBtn(playing) {
            document.getElementById('master-play').innerHTML = playing ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
        }

        function updateProgress() {
            if (ytPlayer && ytPlayer.getCurrentTime) {
                const cur = ytPlayer.getCurrentTime();
                const dur = ytPlayer.getDuration();
                if(dur > 0) {
                    const pct = (cur / dur) * 100;
                    document.getElementById('prog-fill').style.width = pct + '%';
                    document.getElementById('time-cur').innerText = formatTime(cur);
                }
            }
        }

        document.getElementById('prog-container').onclick = (e) => {
            if(!ytPlayer || !ytPlayer.getDuration) return;
            const pct = e.offsetX / e.target.clientWidth;
            ytPlayer.seekTo(pct * ytPlayer.getDuration());
        };

        // --- Data Fetching with Mobile Fixes ---
        async function fetchMusic(term, limit = 10) {
            const url = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&media=music&entity=song&limit=${limit}&country=IQ`;
            try {
                // Try direct first
                let res = await fetch(url);
                if(!res.ok) throw new Error();
                let data = await res.json();
                return mapMusicData(data.results);
            } catch (e) {
                // Try Proxy fallback for mobile networks
                try {
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const res = await fetch(proxyUrl);
                    const data = await res.json();
                    return mapMusicData(data.results);
                } catch (err) { return []; }
            }
        }

        function mapMusicData(results) {
            return results.map(t => ({
                title: t.trackName,
                artist: t.artistName,
                img: t.artworkUrl100.replace('100x100', '500x500'),
                id: t.trackId
            }));
        }

        function createCard(track) {
            const div = document.createElement('div');
            div.className = 'music-card';
            div.innerHTML = `
                <div class="img-box"><img src="${track.img}" loading="lazy" onload="this.classList.add('loaded')"></div>
                <div class="card-title">${track.title}</div>
                <div class="card-subtitle">${track.artist}</div>
            `;
            div.onclick = () => playFullTrack(track);
            return div;
        }

        async function runFullSearch(term) {
            if(!term) return;
            showView('search');
            const resultsArea = document.getElementById('results-area');
            const categoriesArea = document.getElementById('categories-area');
            const grid = document.getElementById('search-grid');
            
            resultsArea.style.display = 'block';
            categoriesArea.style.display = 'none';
            grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> جاري البحث...</div>';
            
            const results = await fetchMusic(term, 24);
            grid.innerHTML = '';
            if(results.length === 0) grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px;">لا توجد نتائج.</div>';
            results.forEach(t => grid.appendChild(createCard(t)));
        }

        document.getElementById('pc-search-in').onkeypress = (e) => { if(e.key === 'Enter') runFullSearch(e.target.value); };
        document.getElementById('mob-search-in').onkeypress = (e) => { if(e.key === 'Enter') runFullSearch(e.target.value); };

        // --- Library ---
        function toggleLike() {
            if(!currentTrack) return;
            const idx = library.findIndex(s => s.title === currentTrack.title);
            if(idx > -1) library.splice(idx, 1); else library.push(currentTrack);
            localStorage.setItem('anghami_v2_lib', JSON.stringify(library));
            updateLikeIcon();
        }

        function updateLikeIcon() {
            if(!currentTrack) return;
            const isLiked = library.some(s => s.title === currentTrack.title);
            const btn = document.getElementById('p-like');
            btn.className = isLiked ? 'fas fa-heart' : 'far fa-heart';
            btn.style.color = isLiked ? 'var(--primary)' : 'white';
        }

        function buildLibrary() {
            const grid = document.getElementById('lib-grid');
            grid.innerHTML = '';
            if(library.length === 0) { grid.innerHTML = '<p style="color:#777; width:100%; text-align:center; padding: 20px;">المكتبة فارغة.</p>'; return; }
            library.forEach(t => grid.appendChild(createCard(t)));
        }

        function formatTime(seconds) {
            if(isNaN(seconds)) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function downloadCurrent() {
            if(!currentTrack) return;
            alert(`تم إضافة "${currentTrack.title}" إلى قائمة التحميل (محاكاة)`);
        }

        // --- Robust Init ---
        async function initApp() {
            // Load sections one by one for better stability
            try {
                const raq = await fetchMusic('سيف نبيل محمود التركي رحمة رياض', 8);
                const listI = document.getElementById('list-iraq');
                if(listI) { listI.innerHTML = ''; raq.forEach(t => listI.appendChild(createCard(t))); }

                const newM = await fetchMusic('Arabic Hits 2024', 8);
                const listN = document.getElementById('list-new');
                if(listN) { listN.innerHTML = ''; newM.forEach(t => listN.appendChild(createCard(t))); }

                const radio = await fetchMusic('كاظم الساهر ماجد المهندس شيرين', 8);
                const listR = document.getElementById('list-radio');
                if(listR) { listR.innerHTML = ''; radio.forEach(t => listR.appendChild(createCard(t))); }
            } catch (e) {
                console.error("Init Error:", e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            showView('discover'); // Ensure discover is shown first
        });
    </script>
</body>
</html>
