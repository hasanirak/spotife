<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="عراق ميوزك">
    
    <!-- Manifest -->
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,{"name":"%D8%B9%D8%B1%D8%A7%D9%82%20%D9%85%D9%8A%D9%88%D8%B2%D9%83","short_name":"Iraq%20Music","start_url":".","display":"standalone","background_color":"#121212","theme_color":"#1db954","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2111/2111624.png","sizes":"512x512","type":"image/png"}]}'>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2111/2111624.png">

    <title>عراق ميوزك | Iraq Music</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #1db954;
            --primary-hover: #1ed760;
            --bg-black: #121212;
            --bg-base: #121212;
            --bg-highlight: #1a1a1a;
            --bg-card: #181818;
            --bg-card-hover: #282828;
            --text-base: #ffffff;
            --text-subdued: #a7a7a7;
            --nav-width: 240px;
            --player-height: 90px;
            --header-height: 64px;
            --mini-player-height: 60px;
            --mobile-nav-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-black);
            color: var(--text-base);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - var(--player-height));
            overflow: hidden;
        }

        /* Sidebar (Desktop) */
        .sidebar {
            width: var(--nav-width);
            background-color: black;
            padding: 24px 10px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 12px;
            color: white;
            font-size: 1.5rem;
            font-weight: 800;
        }
        .logo i { color: var(--primary); font-size: 2rem; }

        .nav-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 10px 16px;
            color: var(--text-subdued);
            text-decoration: none;
            font-weight: 700;
            font-size: 0.95rem;
            border-radius: 4px;
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            color: white;
        }
        .nav-link.active { background-color: #282828; }

        /* Install Button specific style (Desktop Sidebar) */
        .install-link {
            display: none; 
            color: var(--primary) !important;
            font-weight: bold;
        }

        /* Install Button Floating (Mobile) */
        .mobile-install-fab {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            background: var(--primary);
            color: black;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border: none;
        }

        .sidebar-divider {
            height: 1px;
            background-color: #282828;
            margin: 0 16px;
        }

        /* Developer Info Styles */
        .dev-info {
            margin-top: auto;
            padding: 15px;
            text-align: center;
            border-top: 1px solid #282828;
            color: var(--text-subdued);
            font-size: 0.8rem;
        }
        .dev-name { font-weight: bold; color: white; margin-bottom: 4px; }
        .dev-phone { 
            direction: ltr; 
            font-family: monospace; 
            color: var(--primary);
            font-size: 0.9rem;
        }
        .mobile-dev-info {
            display: none;
            text-align: center;
            padding: 30px 20px;
            color: var(--text-subdued);
            font-size: 0.85rem;
            padding-bottom: 150px;
        }

        /* Main Content Area */
        .content-area {
            flex: 1;
            background: linear-gradient(180deg, #2a2a2a 0%, var(--bg-base) 100%);
            overflow-y: auto;
            position: relative;
            padding-bottom: 20px;
            border-radius: 8px 8px 0 0;
            margin-top: 8px;
            margin-left: 8px;
            will-change: transform;
        }

        /* Header */
        .top-bar {
            height: var(--header-height);
            background-color: rgba(0,0,0,0);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            transition: background-color 0.3s;
        }
        .top-bar.scrolled { background-color: rgba(7, 7, 7, 0.95); }

        .search-box {
            background-color: white;
            border-radius: 500px;
            display: flex;
            align-items: center;
            padding: 6px 12px;
            width: 300px;
            color: black;
        }
        .search-box input {
            border: none;
            background: transparent;
            flex: 1;
            padding: 6px;
            font-family: inherit;
            font-weight: 500;
        }
        .search-btn-icon {
            cursor: pointer;
            padding: 5px;
            color: #333;
        }
        .user-pill {
            background-color: rgba(0,0,0,0.7);
            padding: 4px 12px 4px 4px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .user-avatar {
            width: 28px; height: 28px;
            border-radius: 50%;
            background: var(--primary);
            display: flex; justify-content: center; align-items: center; color: black;
        }

        /* Hero Section */
        .hero {
            padding: 20px 24px 24px;
            display: flex;
            align-items: flex-end;
            gap: 24px;
            height: 280px;
            background: linear-gradient(transparent, rgba(0,0,0,0.5));
        }
        .hero-img {
            width: 180px; height: 180px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
            object-fit: cover;
            border-radius: 8px;
        }
        .hero-info h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin: 8px 0;
            letter-spacing: -1px;
            line-height: 1.1;
        }
        .hero-info p { color: rgba(255,255,255,0.8); font-size: 0.9rem; font-weight: 500; }
        
        /* Filters / Tags */
        .tags-container {
            padding: 0 24px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .tag-pill {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.2s;
        }
        .tag-pill:hover { background: rgba(255,255,255,0.2); }
        .tag-pill.active { background: white; color: black; font-weight: bold; }

        /* Grid */
        .grid-section { padding: 0 24px 40px; }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--bg-card);
            padding: 16px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        @media (hover: hover) {
            .card:hover { background-color: var(--bg-card-hover); }
        }
        
        .card-img-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            margin-bottom: 12px;
            border-radius: 4px;
            overflow: hidden;
            background: #333;
        }
        .card-img {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: cover;
            opacity: 0; transition: opacity 0.5s ease;
        }
        .card-img.loaded { opacity: 1; }
        
        .play-btn-overlay {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 44px; height: 44px;
            background-color: var(--primary);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            color: black;
            font-size: 1.2rem;
            z-index: 2;
        }
        @media (hover: hover) {
            .card:hover .play-btn-overlay { opacity: 1; transform: translateY(0); }
            .play-btn-overlay:hover { background-color: var(--primary-hover); transform: scale(1.05) translateY(0); }
        }

        .card-title {
            font-weight: 700;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }
        .card-desc {
            font-size: 0.8rem;
            color: var(--text-subdued);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- Player Bar (Desktop Default) --- */
        .player-bar {
            height: var(--player-height);
            background-color: #181818;
            border-top: 1px solid #282828;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: relative;
            z-index: 200;
        }
        .now-playing { display: flex; align-items: center; width: 30%; min-width: 180px; }
        .np-img { width: 56px; height: 56px; border-radius: 4px; margin-left: 14px; object-fit: cover; background: #333; }
        .np-info { display: flex; flex-direction: column; justify-content: center; margin-left: 14px; overflow: hidden; }
        .np-title { color: white; font-size: 0.9rem; font-weight: 600; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .np-artist { color: var(--text-subdued); font-size: 0.75rem; cursor: pointer; }
        
        .action-icons-wrapper { display: flex; align-items: center; margin-right: 16px; gap: 12px; }
        .like-icon, .dl-icon { color: var(--text-subdued); cursor: pointer; font-size: 1.1rem; transition: 0.2s; }
        .like-icon:hover, .dl-icon:hover { color: white; }
        .like-icon.active { color: var(--primary); }
        .dl-icon.downloading { animation: bounce 1s infinite; color: white; }
        .dl-icon.done { color: var(--primary); }
        
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        .player-controls { display: flex; flex-direction: column; align-items: center; width: 40%; max-width: 722px; }
        .control-buttons { display: flex; align-items: center; gap: 20px; margin-bottom: 8px; }
        .c-btn { background: none; border: none; color: var(--text-subdued); font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .c-btn:hover { color: white; }
        .c-btn.main-play { width: 32px; height: 32px; background: white; color: black; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1rem; }
        .playback-bar { width: 100%; display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: var(--text-subdued); }
        .progress-container { flex: 1; height: 4px; background-color: #4d4d4d; border-radius: 2px; cursor: pointer; position: relative; overflow: hidden; }
        .progress-fill { height: 100%; background-color: white; width: 0%; border-radius: 2px; }
        .volume-controls { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .vol-bar { width: 100px; }

        /* Mobile Bottom Nav */
        .bottom-nav { display: none; }
        
        /* Greeting Header (Mobile Only) */
        .mobile-greeting { display: none; font-size: 1.4rem; font-weight: 800; padding: 20px 24px 10px; margin-top: 20px; }
        
        /* Mobile Search UI */
        .mobile-search-ui {
            display: none;
            padding: 20px 24px;
            background: linear-gradient(180deg, #2a2a2a 0%, var(--bg-base) 100%);
            min-height: 300px;
        }
        .mobile-search-ui.active { display: block; }
        .mobile-search-input-wrapper {
            background-color: white;
            border-radius: 4px;
            padding: 10px 14px;
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 20px;
        }
        .mobile-search-input { border: none; font-size: 1rem; font-weight: 500; width: 100%; outline: none; }

        /* Offline Toast */
        .offline-toast {
            position: fixed;
            top: 20px; left: 50%; transform: translateX(-50%);
            background: #e91429;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .offline-toast.visible { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { top: -50px; } to { top: 20px; } }

        /* --- Responsive Design (Mobile Spotify Look) --- */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .top-bar { display: none; } /* Hide Desktop Header */
            .mobile-dev-info { display: block; }
            .mobile-greeting { display: block; }
            .mobile-install-fab { display: flex; }

            .content-area {
                margin: 0;
                border-radius: 0;
                padding-bottom: 140px;
                /* Darker gradient start for mobile */
                background: linear-gradient(180deg, #222 0%, #121212 40%);
            }

            /* Hiding Desktop Elements on Mobile */
            .desktop-only { display: none !important; }
            .mobile-only { display: block !important; }

            /* Mobile Navigation - Fixed Bottom */
            .bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0; left: 0; right: 0;
                height: var(--mobile-nav-height);
                background: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(18,18,18,0.95) 100%);
                justify-content: space-around;
                align-items: center;
                z-index: 200;
                padding-bottom: env(safe-area-inset-bottom);
            }
            .nav-item {
                display: flex; flex-direction: column; align-items: center;
                color: #b3b3b3; background: none; border: none;
                font-size: 1.4rem; gap: 4px;
                flex: 1;
            }
            .nav-item span { font-size: 0.65rem; font-weight: 400; }
            .nav-item.active { color: white; }
            .nav-item.active i { font-weight: 900; }

            /* Mobile Floating Mini Player */
            .player-bar {
                position: fixed;
                bottom: calc(var(--mobile-nav-height) + 8px + env(safe-area-inset-bottom));
                left: 8px; right: 8px;
                height: var(--mini-player-height);
                background-color: #333333;
                border-radius: 6px;
                border: none;
                padding: 0 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                z-index: 195;
                transition: transform 0.3s ease;
            }
            .now-playing { width: auto; flex: 1; }
            .np-img { width: 40px; height: 40px; margin-left: 0; margin-right: 12px; border-radius: 4px; }
            .np-info { margin-left: 0; }
            .np-title { font-size: 0.85rem; font-weight: 700; }
            .np-artist { font-size: 0.75rem; color: #b3b3b3; }
            
            /* Mini Player Controls */
            .player-controls { 
                width: auto; max-width: none; 
                flex-direction: row; 
                align-items: center;
            }
            .control-buttons { margin-bottom: 0; gap: 16px; margin-left: 8px; }
            /* Hide non-essential buttons on mini player */
            .c-btn { display: none; } 
            .c-btn.main-play { 
                display: flex; 
                background: transparent; 
                color: white; 
                width: auto; height: auto; 
                font-size: 1.5rem; 
            }
            /* Show Actions on Mobile Mini Player */
            .action-icons-wrapper { 
                display: flex; 
                margin-right: 0;
                gap: 16px;
            }
            .like-icon, .dl-icon {
                display: block;
                font-size: 1.2rem;
            }
            .like-icon.active { color: var(--primary); }
            
            .time-display, .volume-controls, .playback-bar { display: none; }
            
            /* Mini Progress Bar */
            .player-bar::after {
                content: '';
                position: absolute;
                bottom: 1px; left: 8px; right: 8px;
                height: 2px;
                background: rgba(255,255,255,0.2);
                border-radius: 2px;
                pointer-events: none;
            }
            .player-bar .progress-container {
                display: block !important;
                position: absolute;
                bottom: 1px; left: 8px; right: 8px;
                height: 2px;
                background: transparent;
                width: auto;
                pointer-events: none;
            }
            .player-bar .progress-fill { background-color: white; }

            /* New Mobile Grid Styles */
            .mobile-top-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                padding: 0 16px;
                margin-bottom: 24px;
            }
            .top-card {
                background: #2a2a2a;
                border-radius: 4px;
                display: flex;
                align-items: center;
                overflow: hidden;
                height: 56px;
                position: relative;
                transition: background 0.2s;
            }
            .top-card:active { background: #3a3a3a; }
            .top-card img { width: 56px; height: 56px; object-fit: cover; }
            .top-card span { font-size: 0.75rem; font-weight: 700; padding: 0 8px; line-height: 1.2; color: white; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

            /* Horizontal Sections */
            .horizontal-section-title {
                padding: 0 16px;
                margin-bottom: 12px;
                font-size: 1.2rem;
                font-weight: 700;
                color: white;
            }
            .horizontal-scroll {
                display: flex;
                gap: 16px;
                overflow-x: auto;
                padding: 0 16px 16px 16px;
                scrollbar-width: none;
            }
            .horizontal-scroll::-webkit-scrollbar { display: none; }
            
            .horizontal-card {
                min-width: 140px;
                width: 140px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .horizontal-card img { width: 140px; height: 140px; object-fit: cover; }
            .horizontal-card .title { font-size: 0.85rem; font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .horizontal-card .desc { font-size: 0.75rem; color: #b3b3b3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

            /* Tags adjustment */
            .tag-pill {
                background: #2a2a2a;
                font-size: 0.8rem;
                padding: 6px 16px;
                border: 1px solid rgba(255,255,255,0.1);
            }
            .tag-pill.active { background: var(--primary); border-color: var(--primary); color: black; }
        }
    </style>
</head>
<body>

    <!-- Offline Toast -->
    <div id="offline-toast" class="offline-toast">
        <i class="fas fa-wifi-slash"></i> لا يوجد اتصال - وضع العمل دون إنترنت
    </div>

    <!-- Mobile Floating Install Button -->
    <button id="mobile-install-btn" class="mobile-install-fab">
        <i class="fas fa-download"></i> تثبيت التطبيق
    </button>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fab fa-spotify"></i>
                <span>عراق ميوزك</span>
            </div>
            <ul class="nav-links">
                <li class="nav-link active" onclick="switchTab('home')">
                    <i class="fas fa-home"></i> الرئيسية
                </li>
                <li class="nav-link" onclick="switchTab('search')">
                    <i class="fas fa-search"></i> بحث
                </li>
                <li class="nav-link" onclick="loadLibrary()">
                    <i class="fas fa-book"></i> مكتبتي
                </li>
                <li id="desktop-install-btn" class="nav-link install-link">
                    <i class="fas fa-arrow-circle-down"></i> تثبيت التطبيق
                </li>
            </ul>
            <div class="sidebar-divider"></div>
            <ul class="nav-links" style="overflow-y:auto; flex:1;">
                <li class="nav-link" onclick="loadCategory('Kadim Al Sahir', 'كاظم الساهر')">كاظم الساهر</li>
                <li class="nav-link" onclick="loadCategory('Majid Al Mohandis', 'ماجد المهندس')">ماجد المهندس</li>
                <li class="nav-link" onclick="loadCategory('Saif Nabeel', 'سيف نبيل')">سيف نبيل</li>
                <li class="nav-link" onclick="loadCategory('Rahma Riad', 'رحمة رياض')">رحمة رياض</li>
            </ul>
            <div class="dev-info">
                <div class="dev-name">المطور حسن داود</div>
                <div class="dev-phone">07762360338</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content-area" id="main-scroll">
            
            <!-- Desktop Top Header -->
            <header class="top-bar" id="top-bar">
                <div class="search-box">
                    <i class="fas fa-search search-btn-icon" onclick="performSearch(document.getElementById('desktop-search-input').value)"></i>
                    <input type="text" id="desktop-search-input" placeholder="ماذا تريد أن تسمع؟">
                </div>
                <div class="user-pill">
                    <div class="user-avatar"><i class="fas fa-user"></i></div>
                    <span>ضيف</span>
                </div>
            </header>

            <!-- Mobile Greeting -->
            <div class="mobile-greeting" id="greeting-msg">طاب مساؤك</div>

            <!-- Mobile Search Interface (Hidden by default) -->
            <div id="mobile-search-view" class="mobile-search-ui">
                <div style="font-size:1.5rem; font-weight:700; margin-bottom:15px;">بحث</div>
                <div class="mobile-search-input-wrapper">
                    <i class="fas fa-search search-btn-icon" onclick="performSearch(document.getElementById('mobile-search-input').value)"></i>
                    <input type="text" id="mobile-search-input" class="mobile-search-input" placeholder="ماذا تريد أن تسمع؟">
                </div>
                <div style="font-weight:700; margin-bottom:10px;">تصفح الكل</div>
                <div class="cards-grid" style="grid-template-columns: repeat(2,1fr);">
                    <div onclick="performSearch('عراقي')" style="background:#27856A; height:100px; border-radius:4px; padding:10px; font-weight:700; position:relative; overflow:hidden; cursor:pointer;">عراقي<img src="https://i.scdn.co/image/ab67706f000000025f828753235d94924c581a06" style="position:absolute; right:-10px; bottom:0; width:60px; transform:rotate(25deg);"></div>
                    <div onclick="performSearch('بوب عربي')" style="background:#E91E63; height:100px; border-radius:4px; padding:10px; font-weight:700; position:relative; overflow:hidden; cursor:pointer;">بوب<img src="https://t.scdn.co/images/0a74d96e091a495bb09c0d83210910c3" style="position:absolute; right:-10px; bottom:0; width:60px; transform:rotate(25deg);"></div>
                    <div onclick="performSearch('موال')" style="background:#1E3264; height:100px; border-radius:4px; padding:10px; font-weight:700; position:relative; overflow:hidden; cursor:pointer;">موال<img src="https://i.scdn.co/image/ab67706f00000002b88126c06a86e885d95e0926" style="position:absolute; right:-10px; bottom:0; width:60px; transform:rotate(25deg);"></div>
                    <div onclick="performSearch('رومانسي')" style="background:#8D67AB; height:100px; border-radius:4px; padding:10px; font-weight:700; position:relative; overflow:hidden; cursor:pointer;">رومانسي<img src="https://i.scdn.co/image/ab67706f0000000213d2f9d8540c11438914b150" style="position:absolute; right:-10px; bottom:0; width:60px; transform:rotate(25deg);"></div>
                </div>
            </div>

            <!-- Home Content -->
            <div id="home-view">
                
                <!-- Desktop Hero (Hidden on Mobile) -->
                <div class="hero desktop-only">
                    <img src="https://images.unsplash.com/photo-1493225255756-d9584f8606e9?q=80&w=800&auto=format&fit=crop" class="hero-img" id="hero-img" alt="Hero" crossorigin="anonymous">
                    <div class="hero-info">
                        <p style="font-size:0.75rem; font-weight:700; letter-spacing:1px; text-transform:uppercase;">قائمة تشغيل</p>
                        <h1 id="hero-title">أفضل أغاني العراق</h1>
                        <p id="hero-desc">أجمل الأغاني العراقية المختارة لك بعناية. تحديث يومي.</p>
                    </div>
                </div>

                <!-- Tags -->
                <div class="tags-container">
                    <button class="tag-pill active" onclick="loadCategory('Iraq Music', 'الكل')">الكل</button>
                    <button class="tag-pill" onclick="loadCategory('Arabic Pop', 'بوب عربي')">بوب عربي</button>
                    <button class="tag-pill" onclick="loadCategory('Iraqi Slow', 'عراقي بطيء')">عراقي بطيء</button>
                </div>

                <!-- Desktop Grid (Vertical) -->
                <div class="grid-section desktop-only">
                    <div class="section-title" id="grid-title">تم إعداده لك</div>
                    <div class="cards-grid" id="cards-container">
                        <!-- Content -->
                    </div>
                </div>

                <!-- Mobile Specific Layout (Hidden on Desktop) -->
                <div class="mobile-only" style="display:none;">
                    <!-- 1. Top Grid (Good Morning Style) -->
                    <div class="mobile-top-grid" id="mobile-top-grid-container">
                        <!-- JS Will Inject 6 Items Here -->
                    </div>

                    <!-- 2. Horizontal Section: Jump Back In -->
                    <div class="horizontal-section-title">مؤخراً</div>
                    <div class="horizontal-scroll" id="mobile-horizontal-1">
                        <!-- JS Will Inject Items Here -->
                    </div>

                    <!-- 3. Horizontal Section: Made For You -->
                    <div class="horizontal-section-title">خصيصاً لك</div>
                    <div class="horizontal-scroll" id="mobile-horizontal-2">
                        <!-- JS Will Inject Items Here -->
                    </div>
                </div>

            </div>

            <!-- Mobile Developer Info -->
            <div class="mobile-dev-info">
                <div>المطور حسن داود</div>
                <div style="direction:ltr; font-weight:bold; margin-top:5px; color:#1db954;">07762360338</div>
            </div>

        </main>
    </div>

    <!-- Sticky Player Bar -->
    <footer class="player-bar">
        <div class="now-playing">
            <img src="https://via.placeholder.com/56" class="np-img" id="np-img" alt="Art">
            <div class="np-info">
                <div class="np-title" id="np-title">اختر أغنية</div>
                <div class="np-artist" id="np-artist">عراق ميوزك</div>
            </div>
            
            <!-- Actions (Like & Download) -->
            <div class="action-icons-wrapper">
                <i class="far fa-heart like-icon" onclick="toggleLike()"></i>
                <i class="fas fa-arrow-circle-down dl-icon" id="download-btn" onclick="downloadCurrentTrack()"></i>
            </div>
        </div>

        <div class="player-controls">
            <div class="control-buttons">
                <button class="c-btn"><i class="fas fa-random"></i></button>
                <button class="c-btn"><i class="fas fa-step-forward"></i></button>
                <button class="c-btn main-play" id="play-pause-btn" onclick="togglePlay()">
                    <i class="fas fa-play" style="margin-right:-2px;"></i>
                </button>
                <button class="c-btn"><i class="fas fa-step-backward"></i></button>
                <button class="c-btn"><i class="fas fa-redo"></i></button>
            </div>
            <div class="playback-bar">
                <span class="time-display" id="curr-time">0:00</span>
                <div class="progress-container" id="progress-bar-container">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <span class="time-display" id="total-time">0:30</span>
            </div>
        </div>

        <div class="volume-controls">
            <i class="fas fa-volume-up c-btn"></i>
            <div class="progress-container vol-bar">
                <div class="progress-fill" style="width: 80%;"></div>
            </div>
        </div>
        
        <audio id="audio-player"></audio>
    </footer>

    <!-- Mobile Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-item active" id="nav-home" onclick="switchTab('home')">
            <i class="fas fa-home"></i>
            <span>الرئيسية</span>
        </button>
        <button class="nav-item" id="nav-search" onclick="switchTab('search')">
            <i class="fas fa-search"></i>
            <span>بحث</span>
        </button>
        <button class="nav-item" id="nav-lib" onclick="loadLibrary()">
            <i class="fas fa-book"></i>
            <span>مكتبتي</span>
        </button>
    </nav>

    <script>
        // --- Variables ---
        const audio = document.getElementById('audio-player');
        const playBtn = document.getElementById('play-pause-btn');
        const progressFill = document.getElementById('progress-fill');
        const progressContainer = document.getElementById('progress-bar-container');
        const container = document.getElementById('cards-container');
        
        // Tab elements
        const homeView = document.getElementById('home-view');
        const searchView = document.getElementById('mobile-search-view');
        const heroSection = document.querySelector('.hero');
        
        // Search inputs
        const desktopSearch = document.getElementById('desktop-search-input');
        const mobileSearch = document.getElementById('mobile-search-input');
        
        // PWA Install
        let deferredPrompt;
        const desktopInstallBtn = document.getElementById('desktop-install-btn');
        const mobileInstallBtn = document.getElementById('mobile-install-btn');
        const isMobile = window.innerWidth <= 768;

        // --- Current Song & Library Logic ---
        let currentTrackData = null; // To store current playing song info
        let library = JSON.parse(localStorage.getItem('my_library') || '[]');

        // --- Greeting Logic ---
        const hour = new Date().getHours();
        const greetingEl = document.getElementById('greeting-msg');
        if (hour < 12) greetingEl.innerText = "صباح الخير";
        else if (hour < 18) greetingEl.innerText = "طاب مساؤك";
        else greetingEl.innerText = "مساء الخير";

        // --- Tab Switching Logic ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            if (tab === 'home') {
                homeView.style.display = 'block';
                searchView.classList.remove('active');
                if(isMobile) document.getElementById('nav-home').classList.add('active');
            } else if (tab === 'search') {
                if(isMobile) {
                    homeView.style.display = 'none';
                    searchView.classList.add('active');
                    document.getElementById('nav-search').classList.add('active');
                    mobileSearch.focus();
                } else {
                    desktopSearch.focus();
                }
            }
        }

        // --- Search Logic with Fallback ---
        function performSearch(term) {
            if(term.trim() === '') return;
            loadCategory(term, 'نتائج البحث عن: ' + term);
            if(isMobile) {
                switchTab('home');
            }
        }

        desktopSearch.addEventListener('keypress', (e) => { if(e.key === 'Enter') performSearch(desktopSearch.value); });
        mobileSearch.addEventListener('keypress', (e) => { if(e.key === 'Enter') performSearch(mobileSearch.value); });

        // --- Install Logic ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            desktopInstallBtn.style.display = 'flex';
            if(isMobile) mobileInstallBtn.style.display = 'flex';
        });

        function handleInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        desktopInstallBtn.style.display = 'none';
                        mobileInstallBtn.style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            } else {
                alert("لتثبيت التطبيق: اضغط على زر المشاركة ثم اختر 'إضافة إلى الصفحة الرئيسية'.");
            }
        }
        desktopInstallBtn.addEventListener('click', handleInstall);
        mobileInstallBtn.addEventListener('click', handleInstall);
        if(isMobile) setTimeout(() => { mobileInstallBtn.style.display = 'flex'; }, 2000);

        // --- Network Logic & Caching ---
        
        function showOfflineToast() {
            const toast = document.getElementById('offline-toast');
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        async function fetchTracks(term) {
            // Show loading indicators
            if(!isMobile) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;"><i class="fas fa-circle-notch fa-spin fa-2x" style="color:#1db954;"></i></div>';
            }
            
            // Check Offline first
            if (!navigator.onLine) {
                showOfflineToast();
                loadFromCache(term);
                return;
            }

            const url = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&media=music&entity=song&limit=80&country=IQ`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error();
                const data = await res.json();
                
                if(data.resultCount === 0) {
                    container.innerHTML = '<div style="padding:50px; text-align:center; color:#777">لا توجد نتائج</div>';
                    return;
                }
                
                // Save to Cache
                localStorage.setItem('cache_' + term, JSON.stringify(data.results));
                renderData(data.results);
                
            } catch (e) {
                // Try Proxy
                try {
                    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const res2 = await fetch(proxy);
                    if(!res2.ok) throw new Error();
                    const data2 = await res2.json();
                    
                    localStorage.setItem('cache_' + term, JSON.stringify(data2.results));
                    renderData(data2.results);
                } catch (err) {
                    // Try loading from cache if network fails
                    loadFromCache(term);
                }
            }
        }

        function loadFromCache(term) {
            const cached = localStorage.getItem('cache_' + term);
            if (cached) {
                console.log('Loaded from cache');
                renderData(JSON.parse(cached));
            } else {
                container.innerHTML = '<div style="padding:50px; text-align:center; color:#777">خطأ في الاتصال ولا توجد بيانات محفوظة.</div>';
            }
        }

        // Unified Render Function
        function renderData(tracks) {
            // Desktop Render (Grid)
            container.innerHTML = '';
            const frag = document.createDocumentFragment();
            
            // Mobile Containers
            const mobileTopGrid = document.getElementById('mobile-top-grid-container');
            const mobileH1 = document.getElementById('mobile-horizontal-1');
            const mobileH2 = document.getElementById('mobile-horizontal-2');
            
            mobileTopGrid.innerHTML = '';
            mobileH1.innerHTML = '';
            mobileH2.innerHTML = '';

            tracks.forEach((track, index) => {
                if(!track.previewUrl) return;

                const img = track.artworkUrl100 ? track.artworkUrl100.replace('100x100', '300x300') : 'https://via.placeholder.com/300';
                const safeTitle = (track.trackName || 'Unknown').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                const safeArtist = (track.artistName || 'Unknown').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                
                const trackData = { title: safeTitle, artist: safeArtist, img: img, url: track.previewUrl };

                // 1. Desktop Card
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="${img}" class="card-img" loading="lazy" onload="this.classList.add('loaded')">
                        <div class="play-btn-overlay"><i class="fas fa-play"></i></div>
                    </div>
                    <div class="card-title">${safeTitle}</div>
                    <div class="card-desc">${safeArtist}</div>
                `;
                card.onclick = () => playTrack(trackData);
                frag.appendChild(card);

                // 2. Mobile Logic
                if (isMobile) {
                    // First 6 go to Top Grid
                    if (index < 6) {
                        const topCard = document.createElement('div');
                        topCard.className = 'top-card';
                        topCard.innerHTML = `
                            <img src="${img}">
                            <span>${safeTitle}</span>
                        `;
                        topCard.onclick = () => playTrack(trackData);
                        mobileTopGrid.appendChild(topCard);
                    } 
                    // Next 10 go to Horizontal 1
                    else if (index < 16) {
                        const hCard = createHorizontalCard(trackData);
                        mobileH1.appendChild(hCard);
                    }
                    // Next 10 go to Horizontal 2
                    else if (index < 26) {
                        const hCard = createHorizontalCard(trackData);
                        mobileH2.appendChild(hCard);
                    }
                }
            });
            container.appendChild(frag);
        }

        function createHorizontalCard(trackData) {
            const div = document.createElement('div');
            div.className = 'horizontal-card';
            div.innerHTML = `
                <img src="${trackData.img}">
                <div class="title">${trackData.title}</div>
                <div class="desc">${trackData.artist}</div>
            `;
            div.onclick = () => playTrack(trackData);
            return div;
        }

        // --- Audio & Library Logic ---
        let isPlaying = false;

        function playTrack(trackData) {
            if(!trackData.url) return alert('المعاينة غير متاحة');
            
            currentTrackData = trackData; // Save current song info
            
            // Check library status
            updateLikeButtonState();
            
            // Reset download button
            const dlBtn = document.getElementById('download-btn');
            dlBtn.className = 'fas fa-arrow-circle-down dl-icon';

            audio.src = trackData.url;
            audio.play().then(() => { isPlaying = true; updatePlayBtn(); }).catch(e => console.log(e));
            
            document.getElementById('np-title').innerText = trackData.title;
            document.getElementById('np-artist').innerText = trackData.artist;
            document.getElementById('np-img').src = trackData.img;
            
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: trackData.title, artist: trackData.artist, artwork: [{ src: trackData.img, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
            }
        }

        function togglePlay() {
            if(audio.paused) {
                audio.play().then(() => { isPlaying = true; updatePlayBtn(); });
            } else {
                audio.pause(); isPlaying = false; updatePlayBtn();
            }
        }

        function updatePlayBtn() {
            const icon = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play" style="margin-right:-2px;"></i>';
            playBtn.innerHTML = icon;
        }

        // --- Download Logic ---
        async function downloadCurrentTrack() {
            if (!currentTrackData) return alert("قم بتشغيل أغنية أولاً");
            
            const btn = document.getElementById('download-btn');
            btn.classList.add('downloading');
            
            try {
                // Fetch blob
                const response = await fetch(currentTrackData.url);
                if (!response.ok) throw new Error('Network error');
                const blob = await response.blob();
                
                // Create object URL
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${currentTrackData.title} - ${currentTrackData.artist}.m4a`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                btn.classList.remove('downloading');
                btn.classList.add('done');
                setTimeout(() => btn.classList.remove('done'), 2000);
            } catch (e) {
                console.error(e);
                alert("فشل التحميل. قد يكون بسبب قيود المتصفح.");
                btn.classList.remove('downloading');
                
                // Fallback to direct link if fetch fails
                window.open(currentTrackData.url, '_blank');
            }
        }

        audio.addEventListener('timeupdate', () => {
            const pct = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = pct + '%';
            document.querySelectorAll('.progress-fill').forEach(el => el.style.width = pct + '%');
            const curM = Math.floor(audio.currentTime / 60);
            const curS = Math.floor(audio.currentTime % 60);
            document.getElementById('curr-time').innerText = `${curM}:${curS<10?'0':''}${curS}`;
        });
        
        audio.addEventListener('ended', () => { isPlaying = false; updatePlayBtn(); });

        // --- Categories ---
        function loadCategory(term, title) {
            if(title) {
                document.getElementById('grid-title').innerText = title;
                document.getElementById('hero-title').innerText = title;
            } else {
                document.getElementById('grid-title').innerText = term;
                document.getElementById('hero-title').innerText = term;
            }
            fetchTracks(term);
        }

        // --- Library System ---
        function toggleLike() {
            if (!currentTrackData) return;

            const index = library.findIndex(t => t.url === currentTrackData.url);
            
            if (index > -1) {
                // Remove
                library.splice(index, 1);
            } else {
                // Add
                library.push(currentTrackData);
            }
            
            localStorage.setItem('my_library', JSON.stringify(library));
            updateLikeButtonState();
            
            // If we are currently viewing the library, reload it
            if(document.getElementById('grid-title').innerText === 'مكتبتي') {
                loadLibrary();
            }
        }

        function updateLikeButtonState() {
            if (!currentTrackData) return;
            const isLiked = library.some(t => t.url === currentTrackData.url);
            const btns = document.querySelectorAll('.like-icon');
            
            btns.forEach(btn => {
                if (isLiked) {
                    btn.classList.add('active');
                    btn.className = 'fas fa-heart like-icon active';
                } else {
                    btn.classList.remove('active');
                    btn.className = 'far fa-heart like-icon';
                }
            });
        }

        function loadLibrary() {
            document.getElementById('grid-title').innerText = 'مكتبتي';
            document.getElementById('hero-title').innerText = 'مكتبتي';
            
            if (isMobile) {
                homeView.style.display = 'block';
                searchView.classList.remove('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById('nav-lib').classList.add('active');
                
                // Hide home sections, show grid only for library
                document.querySelector('.mobile-only').innerHTML = '<div class="cards-grid" id="mobile-lib-grid" style="grid-template-columns: repeat(2, 1fr); padding: 0 16px;"></div>';
            }

            if (library.length === 0) {
                const msg = '<div style="padding:50px; text-align:center; color:#777">لم تقم بحفظ أي أغانٍ بعد.<br>اضغط على القلب لحفظ الأغاني.</div>';
                container.innerHTML = msg;
                if(isMobile) document.getElementById('mobile-lib-grid').innerHTML = msg;
                return;
            }

            // Render library items
            container.innerHTML = '';
            const frag = document.createDocumentFragment();
            const mobileFrag = document.createDocumentFragment();
            
            library.forEach(track => {
                // Desktop
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="${track.img}" class="card-img" loading="lazy" onload="this.classList.add('loaded')">
                        <div class="play-btn-overlay"><i class="fas fa-play"></i></div>
                    </div>
                    <div class="card-title">${track.title}</div>
                    <div class="card-desc">${track.artist}</div>
                `;
                card.onclick = () => playTrack(track);
                frag.appendChild(card);

                // Mobile Library Grid (Reuse basic card style)
                if(isMobile) {
                    const mCard = document.createElement('div');
                    mCard.className = 'card'; // Use existing card class which is styled for grid
                    mCard.innerHTML = `
                        <div class="card-img-wrapper">
                            <img src="${track.img}" class="card-img" style="opacity:1;">
                        </div>
                        <div class="card-title">${track.title}</div>
                        <div class="card-desc">${track.artist}</div>
                    `;
                    mCard.onclick = () => playTrack(track);
                    mobileFrag.appendChild(mCard);
                }
            });
            container.appendChild(frag);
            if(isMobile) document.getElementById('mobile-lib-grid').appendChild(mobileFrag);
        }

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            loadCategory('Iraq Top Hits', 'أفضل الأغاني العراقية');
            
            // Check connection status listener
            window.addEventListener('online', () => document.getElementById('offline-toast').classList.remove('visible'));
            window.addEventListener('offline', showOfflineToast);
        });
    </script>
</body>
</html>
